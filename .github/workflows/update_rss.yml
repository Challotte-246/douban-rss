name: Update Douban RSS

on:
  schedule:
    - cron: "0 */4 * * *"  # æ¯4å°æ—¶æ›´æ–°ä¸€æ¬¡
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        # è§£å†³Gitå®‰å…¨ç›®å½•é—®é¢˜
        safe-directory: /home/runner/work/douban-rss/douban-rss
    
    # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
        # æ·»åŠ ç¼“å­˜æ¸…ç†
        cache: 'pip'
        cache-dependency-path: '**/requirements.txt'
    
    # æ­¥éª¤3: å®‰è£…ä¾èµ–åŒ…ï¼ˆä¿®å¤æ­¤å¤„ï¼‰
    - name: Install dependencies
      run: |
        # æ¸…é™¤pipç¼“å­˜é˜²æ­¢æ—§åŒ…å½±å“
        python -m pip cache purge
        
        # å‡çº§pipå¹¶å®‰è£…ä¾èµ–
        python -m pip install --upgrade pip
        pip install beautifulsoup4 feedgenerator requests --no-cache-dir
        
        # éªŒè¯å®‰è£…
        pip list | grep -E "beautifulsoup4|feedgenerator|requests"
    
    # æ­¥éª¤4: æ·»åŠ éšæœºå»¶è¿Ÿ
    - name: Add random delay
      run: |
        DELAY=$(($RANDOM % 30 + 10))
        echo "ç­‰å¾… ${DELAY} ç§’..."
        sleep $DELAY
    
    # æ­¥éª¤5: è¿è¡ŒæŠ“å–è„šæœ¬
    - name: Run scraper
      run: python douban_rss.py
    
    # æ­¥éª¤6: æäº¤ç”Ÿæˆçš„RSSæ–‡ä»¶
    - name: Commit RSS file
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global --add safe.directory /home/runner/work/douban-rss/douban-rss
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
        if [ -n "$(git status --porcelain)" ]; then
          git add douban_*.xml
          git commit -m "è‡ªåŠ¨æ›´æ–° RSS [$(date +'%Y-%m-%d %H:%M')]"
          git push origin HEAD:main
          echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
        else
          echo "ğŸŸ¢ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi

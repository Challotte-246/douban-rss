name: Update Douban RSS

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        path: 'source'
        
    # æ­¥éª¤2: è®¾ç½®Pythonç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    # æ­¥éª¤3: å®‰è£…ä¾èµ–åŒ…
    - name: Install dependencies
      run: |
        pip install beautifulsoup4 requests
        
    # æ­¥éª¤4: æ·»åŠ éšæœºå»¶è¿Ÿ
    - name: Add random delay
      run: |
        DELAY=$(($RANDOM % 30 + 10))
        echo "ç­‰å¾… ${DELAY} ç§’..."
        sleep $DELAY
    
    # æ­¥éª¤5: è¿è¡ŒæŠ“å–è„šæœ¬
    - name: Run scraper
      working-directory: ./source
      run: python douban_rss.py
      
    # æ­¥éª¤6: æäº¤ç”Ÿæˆçš„RSSæ–‡ä»¶
    - name: Commit RSS files
      working-directory: ./source
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # é…ç½®Gitç”¨æˆ·
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # æ·»åŠ å¹¶æäº¤XMLæ–‡ä»¶
        git add douban_*.xml
        
        # æ£€æŸ¥å˜åŒ–å¹¶æäº¤
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "è‡ªåŠ¨æ›´æ–°ä¸‰ç§RSSæº [$(date +'%Y-%m-%d %H:%M')]"
          git push origin HEAD:main
          echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
        else
          echo "ğŸŸ¢ æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
